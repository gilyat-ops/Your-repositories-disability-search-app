<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>×—×™×¤×•×© + ×©×§×œ×•×œ ××—×•×–×™ × ×›×•×ª</title>
</head>
<body style="font-family: Arial; padding: 16px; max-width: 1000px; margin: 0 auto; background:#fafafa;">
  <h2 style="margin:0 0 10px 0;">×—×™×¤×•×© + ×©×§×œ×•×œ ××—×•×–×™ × ×›×•×ª</h2>

  <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start;">
    <!-- ×—×™×¤×•×© -->
    <div style="flex: 1 1 520px; background:#fff; border:1px solid #e6e6e6; border-radius:16px; padding:14px;">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <input id="search"
               placeholder="×”×§×œ×“ ××—×œ×” / ×ª×ª-××—×œ×” / ×ª× ××™ / ××¢×¨×›×ªâ€¦"
               style="flex:1 1 260px; padding:12px; font-size:18px; box-sizing:border-box; border:1px solid #ccc; border-radius:12px;"/>

        <select id="systemFilter"
                style="flex:0 0 220px; padding:12px; font-size:16px; border:1px solid #ccc; border-radius:12px;">
          <option value="">×›×œ ×”××¢×¨×›×•×ª</option>
        </select>

        <button id="clearBtn"
                style="padding:12px 14px; font-size:16px; border:1px solid #ccc; border-radius:12px; background:#fff; cursor:pointer;">
          × ×™×§×•×™
        </button>
      </div>

      <div id="status" style="margin:10px 2px; opacity:0.85;">×˜×•×¢×Ÿ × ×ª×•× ×™×â€¦</div>
      <div id="results"></div>
    </div>

    <!-- ××—×©×‘×•×Ÿ -->
    <div style="flex: 0 0 360px; background:#fff; border:1px solid #e6e6e6; border-radius:16px; padding:14px;">
      <h3 style="margin:0 0 10px 0;">ğŸ§® ××—×©×‘×•×Ÿ ×©×§×œ×•×œ</h3>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <div style="opacity:0.8;">× ×•×¡×—×”:</div>
        <code style="background:#f3f3f3; padding:6px 8px; border-radius:10px;">
          total = total + p*(100-total)/100
        </code>
      </div>

      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
        <button id="clearCart"
                style="flex:1; padding:12px; border:1px solid #ccc; border-radius:12px; background:#fff; cursor:pointer;">
          ğŸ§¹ ××™×¤×•×¡ ×¨×©×™××”
        </button>
        <button id="copySummary"
                style="flex:1; padding:12px; border:1px solid #ccc; border-radius:12px; background:#fff; cursor:pointer;">
          ğŸ“‹ ×”×¢×ª×§ ×¡×™×›×•×
        </button>
      </div>

      <div id="cartMeta" style="margin-top:12px; font-weight:700;"></div>
      <div id="cartList" style="margin-top:10px;"></div>

      <div style="margin-top:12px; padding:12px; border:1px dashed #ddd; border-radius:14px;">
        <div style="font-size:14px; opacity:0.85;">×ª×•×¦××” ××©×•×§×œ×œ×ª</div>
        <div style="display:flex; justify-content:space-between; align-items:baseline; gap:10px; margin-top:6px;">
          <div style="font-size:18px; font-weight:900;" id="totalPct">â€”</div>
          <div style="font-size:14px; opacity:0.85;" id="totalPctRounded"></div>
        </div>
      </div>

      <div style="margin-top:10px; font-size:13px; opacity:0.8;">
        ×˜×™×¤: ×”×©×§×œ×•×œ ×¢×•×‘×“ ×”×›×™ × ×›×•×Ÿ ×›×©××•×¡×™×¤×™× ×›××” ×¡×¢×™×¤×™×, ×•×”×•× ×ª××™×“ ×™×•×¦× â‰¤ 100%.
      </div>
    </div>
  </div>

<script>
  const statusEl = document.getElementById('status');
  const resultsEl = document.getElementById('results');
  const searchEl  = document.getElementById('search');
  const systemEl  = document.getElementById('systemFilter');
  const clearBtn  = document.getElementById('clearBtn');

  const cartMetaEl = document.getElementById('cartMeta');
  const cartListEl = document.getElementById('cartList');
  const totalPctEl = document.getElementById('totalPct');
  const totalPctRoundedEl = document.getElementById('totalPctRounded');
  const clearCartBtn = document.getElementById('clearCart');
  const copySummaryBtn = document.getElementById('copySummary');

  const safe = v => (v === null || v === undefined) ? "" : String(v);
  const norm = s => safe(s).trim().toLowerCase();

  function escapeHtml(str){
    return safe(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // --- DATA ---
  let DATA = [];
  let SYSTEMS = [];

  // --- CART ---
  // item = { id, title, system, condition, percent }
  let CART = [];
  let nextId = 1;

  function buildSystemOptions(){
    const current = systemEl.value;
    systemEl.innerHTML = `<option value="">×›×œ ×”××¢×¨×›×•×ª</option>` + SYSTEMS
      .map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`)
      .join("");
    if(SYSTEMS.includes(current)) systemEl.value = current;
  }

  function calcCombinedPercent(percentList){
    // percentList: array of numbers [p1, p2...]
    const ps = percentList
      .map(p => Number(p))
      .filter(p => Number.isFinite(p) && p > 0)
      .sort((a,b) => b-a); // ××”×’×‘×•×” ×œ× ××•×š

    let total = 0;
    for(const p of ps){
      total = total + (p * (100 - total) / 100);
    }
    return total; // ×™×›×•×œ ×œ×”×™×•×ª ×¢× ×©×‘×¨×™×
  }

  function updateCartUI(){
    cartMetaEl.textContent = CART.length ? `× ×‘×—×¨×• ${CART.length} ×¡×¢×™×¤×™×` : "×¢×•×“ ×œ× × ×‘×—×¨×• ×¡×¢×™×¤×™×.";
    const percents = CART.map(x => x.percent);
    const total = calcCombinedPercent(percents);

    if(!CART.length){
      totalPctEl.textContent = "â€”";
      totalPctRoundedEl.textContent = "";
      cartListEl.innerHTML = `<div style="opacity:0.7">×”×•×¡×™×¤×™ ×¡×¢×™×¤×™× ××ª×•×š ×”×ª×•×¦××•×ª (×›×¤×ª×•×¨ â•).</div>`;
      return;
    }

    totalPctEl.textContent = `${total.toFixed(1)}%`;
    totalPctRoundedEl.textContent = `××¢×•×’×œ: ${Math.round(total)}%`;

    cartListEl.innerHTML = CART.map(item => `
      <div style="border:1px solid #eee; border-radius:14px; padding:10px; margin:8px 0; background:#fff;">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
          <div style="font-weight:800; font-size:14px; line-height:1.25;">
            ${escapeHtml(item.title || "â€”")}
            <div style="font-weight:400; opacity:0.8; margin-top:4px;">
              ${escapeHtml(item.system || "â€”")}
            </div>
          </div>
          <div style="text-align:left; white-space:nowrap;">
            <div style="font-weight:900; font-size:16px;">${escapeHtml(item.percent)}%</div>
            <button data-remove="${item.id}"
                    style="margin-top:6px; padding:8px 10px; border:1px solid #ccc; border-radius:12px; background:#fff; cursor:pointer;">
              âœ– ×”×¡×¨
            </button>
          </div>
        </div>
        <div style="opacity:0.85; font-size:13px; margin-top:8px;">
          ${escapeHtml(item.condition || "")}
        </div>
      </div>
    `).join("");

    // remove handlers
    document.querySelectorAll('[data-remove]').forEach(btn => {
      btn.onclick = () => {
        const id = Number(btn.getAttribute('data-remove'));
        CART = CART.filter(x => x.id !== id);
        updateCartUI();
      };
    });
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    } catch(e){
      // fallback
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      return true;
    }
  }

  function addToCart(x){
    const disease = safe(x.disease);
    const sub     = safe(x.sub_disease);
    const title = [disease, (sub && sub !== "â€”") ? sub : ""].filter(Boolean).join(" â€¢ ");

    // percent: ××¦×œ×š ×›×‘×¨ 0-100 (×‘× ×™×ª×™ ×›×š ××ª ×”×§×•×‘×¥)
    const pct = Number(x.percent);
    if(!Number.isFinite(pct) || pct <= 0){
      alert("××™×Ÿ ××—×•×– ×ª×§×™×Ÿ ×œ×©×•×¨×” ×”×–×•.");
      return;
    }

    CART.push({
      id: nextId++,
      title,
      system: safe(x.system),
      condition: safe(x.condition),
      percent: Math.round(pct) // ××¤×©×¨ ×œ×©× ×•×ª ×œ-pct ×× ×ª×¨×¦×™ ×œ× ×œ×¢×’×œ ×¡×¢×™×¤×™×
    });

    updateCartUI();
  }

  // --- SEARCH RENDER ---
  function renderResults(){
    const q = norm(searchEl.value);
    const sysFilter = norm(systemEl.value);

    if(!q && !sysFilter){
      statusEl.textContent = `× ×˜×¢× ×• ${DATA.length} ×¨×©×•××•×ª âœ… Â· ×”×§×œ×™×“×™ ×›×“×™ ×œ×—×¤×© ××• ×‘×—×¨×™ ××¢×¨×›×ª.`;
      resultsEl.innerHTML = `<div style="opacity:0.7; margin-top:10px;">×˜×™×¤: ×›×ª×‘×™ "×‘×¨×š" / "×˜×¨×©×ª" / "×¡×¨×˜×Ÿ"â€¦</div>`;
      return;
    }

    let out = DATA.filter(x => {
      const sys = norm(x.system);
      if(sysFilter && sys !== sysFilter) return false;
      if(!q) return true;

      const blob = (
        safe(x.disease) + " " +
        safe(x.sub_disease) + " " +
        safe(x.condition) + " " +
        safe(x.system)
      ).toLowerCase();

      return blob.includes(q);
    });

    const total = out.length;
    out = out.slice(0, 200);

    statusEl.textContent = `× ××¦××• ${total} ×ª×•×¦××•×ª Â· ××¦×™×’ ×¢×“ 200`;

    resultsEl.innerHTML = out.length ? out.map((x, idx) => {
      const title = [safe(x.disease), safe(x.sub_disease)].filter(Boolean).join(" â€¢ ");
      const pct = safe(x.percent) ? (safe(x.percent) + "%") : "â€”";
      const sys = safe(x.system);
      const cond = safe(x.condition);

      // ×©×•××¨×™× ××™× ×“×§×¡ ×›×“×™ ×œ×”×•×¡×™×£ ×œ×¡×œ
      return `
        <div style="border:1px solid #e6e6e6; border-radius:14px; padding:12px; margin:10px 0; background:#fff;">
          <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start;">
            <div style="font-weight:800; font-size:15px;">${escapeHtml(title || "â€”")}</div>
            <div style="display:flex; gap:8px; align-items:center;">
              <div style="font-weight:900; font-size:18px; white-space:nowrap;">${escapeHtml(pct)}</div>
              <button data-add="${idx}"
                      style="padding:10px 12px; border:1px solid #ccc; border-radius:12px; background:#fff; cursor:pointer;">
                â•
              </button>
            </div>
          </div>
          <div style="margin-top:6px; opacity:0.85; font-size:13px;"><b>××¢×¨×›×ª:</b> ${escapeHtml(sys || "â€”")}</div>
          <div style="margin-top:6px; opacity:0.85; font-size:13px;"><b>×ª× ××™:</b> ${escapeHtml(cond || "â€”")}</div>
        </div>
      `;
    }).join("") : `<div style="opacity:0.7; margin-top:10px;">×œ× × ××¦××• ×ª×•×¦××•×ª.</div>`;

    // add handlers (×œ×¤×™ ××™× ×“×§×¡ ×‘×ª×•×š out.slice)
    // ×›×“×™ ×œ×¤×©×˜: × ×‘× ×” ××—×“×© ××¢×¨×š ×”×ª×•×¦××•×ª ×©×× ×—× ×• ××¦×™×’×™× ×›×¨×’×¢
    const displayed = DATA.filter(x => {
      const sys = norm(x.system);
      if(sysFilter && sys !== sysFilter) return false;
      if(!q) return true;
      const blob = (safe(x.disease)+" "+safe(x.sub_disease)+" "+safe(x.condition)+" "+safe(x.system)).toLowerCase();
      return blob.includes(q);
    }).slice(0, 200);

    document.querySelectorAll('[data-add]').forEach(btn => {
      btn.onclick = () => {
        const i = Number(btn.getAttribute('data-add'));
        const row = displayed[i];
        if(row) addToCart(row);
      };
    });
  }

  // debounce
  let t = null;
  function scheduleRender(){
    clearTimeout(t);
    t = setTimeout(renderResults, 80);
  }

  clearBtn.onclick = () => {
    searchEl.value = "";
    systemEl.value = "";
    renderResults();
    searchEl.focus();
  };

  clearCartBtn.onclick = () => {
    CART = [];
    updateCartUI();
  };

  copySummaryBtn.onclick = async () => {
    if(!CART.length){
      alert("××™×Ÿ ×¡×¢×™×¤×™× ×‘×¨×©×™××”.");
      return;
    }
    const total = calcCombinedPercent(CART.map(x => x.percent));
    const lines = CART
      .slice()
      .sort((a,b)=>b.percent-a.percent)
      .map(x => `${x.percent}% â€” ${x.title}`);
    const summary =
      `×©×§×œ×•×œ ××—×•×–×™ × ×›×•×ª (××¦×˜×‘×¨):\n` +
      lines.join("\n") +
      `\n\n×¡×”×´×› ××©×•×§×œ×œ: ${total.toFixed(1)}% (××¢×•×’×œ: ${Math.round(total)}%)`;

    const ok = await copyText(summary);
    if(ok) alert("×”×¡×™×›×•× ×”×•×¢×ª×§ âœ…");
  };

  // --- LOAD ---
  statusEl.textContent = "×˜×•×¢×Ÿ × ×ª×•× ×™×â€¦";
  fetch('./disability_table.json', { cache: "no-store" })
    .then(r => {
      if(!r.ok) throw new Error("×œ× × ×˜×¢×Ÿ disability_table.json (×¡×˜×˜×•×¡ " + r.status + ")");
      return r.json();
    })
    .then(data => {
      DATA = Array.isArray(data) ? data : [];

      // systems
      const set = new Set();
      for(const x of DATA){
        const s = safe(x.system).trim();
        if(s) set.add(s);
      }
      SYSTEMS = Array.from(set).sort((a,b)=>a.localeCompare(b, 'he'));
      buildSystemOptions();

      statusEl.textContent = `× ×˜×¢× ×• ${DATA.length} ×¨×©×•××•×ª âœ…`;
      updateCartUI();
      renderResults();

      searchEl.addEventListener('input', scheduleRender);
      systemEl.addEventListener('change', renderResults);
    })
    .catch(err => {
      statusEl.textContent = "×©×’×™××”: " + err.message;
      resultsEl.innerHTML = `<div style="opacity:0.7">×‘×“×§×™ ×©×”×§×•×‘×¥ disability_table.json × ××¦× ×‘××•×ª×• ××§×•× ×›××• index.html.</div>`;
      console.error(err);
    });
</script>
</body>
</html>
