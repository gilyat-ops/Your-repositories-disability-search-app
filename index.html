<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>חיפוש אחוזי נכות</title>
</head>
<body style="font-family: Arial; padding: 16px;">
  <h2 style="margin-top:0;">חיפוש אחוזי נכות</h2>

  <input id="search" placeholder="הקלד מחלה / תת-מחלה / תנאי…"
         style="width:100%;padding:12px;font-size:18px;box-sizing:border-box"/>

  <div id="status" style="margin:10px 0; opacity:0.8;">טוען נתונים…</div>
  <div id="results"></div>

<script>
  const statusEl = document.getElementById('status');
  const resultsEl = document.getElementById('results');
  const searchEl  = document.getElementById('search');

  const safe = v => (v === null || v === undefined) ? "" : String(v);

  fetch('./disability_table.json', { cache: "no-store" })
    .then(r => {
      if (!r.ok) throw new Error("לא נטען disability_table.json (סטטוס " + r.status + ")");
      return r.json();
    })
    .then(data => {
      statusEl.textContent = "נטענו " + data.length + " רשומות ✅";

      function render(q){
        const query = safe(q).trim().toLowerCase();
        if (!query){
          resultsEl.innerHTML = "<div style='opacity:0.7'>הקלידי משהו כדי לחפש.</div>";
          return;
        }

        const out = data.filter(x => {
          const blob = (
            safe(x.disease) + " " +
            safe(x.sub_disease) + " " +
            safe(x.condition) + " " +
            safe(x.system)
          ).toLowerCase();
          return blob.includes(query);
        }).slice(0, 200);

        resultsEl.innerHTML = out.length
          ? out.map(x => {
              const title = [safe(x.disease), safe(x.sub_disease)].filter(Boolean).join(" • ");
              const pct = safe(x.percent) ? (safe(x.percent) + "%") : "—";
              return `
                <div style="border:1px solid #ddd;border-radius:12px;padding:12px;margin:10px 0;">
                  <div style="display:flex;justify-content:space-between;gap:10px;">
                    <div style="font-weight:700;">${title || "—"}</div>
                    <div style="font-weight:800;font-size:18px;">${pct}</div>
                  </div>
                  <div style="opacity:0.8;margin-top:6px;">${safe(x.system)}</div>
                  <div style="opacity:0.8;margin-top:6px;">${safe(x.condition)}</div>
                </div>
              `;
            }).join("")
          : "<div style='opacity:0.7'>לא נמצאו תוצאות.</div>";
      }

      searchEl.addEventListener('input', e => render(e.target.value));
      render("");
    })
    .catch(err => {
      statusEl.textContent = "שגיאה: " + err.message;
      resultsEl.innerHTML = "<div style='opacity:0.7'>ה-JSON נטען אבל הקוד נפל. נסי רענון קשוח.</div>";
      console.error(err);
    });
</script>
</body>
</html>
