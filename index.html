<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>חיפוש + שקלול אחוזי נכות</title>

  <!-- PWA (לא חובה אבל נחמד) -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff" />

  <style>
    :root{
      --border:#e6e6e6;
      --muted:#6b7280;
      --bg:#ffffff;
      --card:#ffffff;
      --accent:#7c3aed;
      --shadow: 0 10px 30px rgba(0,0,0,.05);
      --radius:22px;
      --radius2:18px;
      --font: system-ui,-apple-system,"Segoe UI",Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background:var(--bg);
      color:#111;
    }
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:20px 18px 32px;
    }
    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      margin-bottom:14px;
    }
    h1{
      margin:0;
      font-size:38px;
      font-weight:900;
      letter-spacing:.2px;
    }
    #ver{
      margin-top:8px;
      color:var(--muted);
      font-size:16px;
      font-weight:600;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:18px;
      align-items:start;
      margin-top:16px;
    }
    @media (max-width: 980px){
      header{flex-direction:column; align-items:flex-start}
      .grid{grid-template-columns:1fr}
      h1{font-size:30px}
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:none;
    }
    .cardTitle{
      font-size:22px;
      font-weight:900;
      margin:0 0 12px 0;
    }

    .row{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    input, select{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px 14px;
      font-size:18px;
      outline:none;
      min-height:46px;
      background:#fff;
    }
    input:focus, select:focus{
      border-color:#111;
      box-shadow:0 0 0 3px rgba(0,0,0,.08);
    }
    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:16px;
      padding:10px 16px;
      font-size:18px;
      cursor:pointer;
      min-height:46px;
      font-weight:700;
    }
    .btn:hover{background:#fafafa}
    .btnPrimary{
      border-color:#111;
    }

    .small{
      color:var(--muted);
      font-size:16px;
      font-weight:600;
    }

    .list{
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .item{
      border:1px solid #ededed;
      border-radius:var(--radius);
      padding:16px;
      display:grid;
      grid-template-columns: 86px 1fr;
      gap:14px;
      background:#fff;
    }
    .pctBox{
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      gap:10px;
      font-weight:900;
      font-size:22px;
      line-height:1;
    }
    .plusBtn{
      width:44px;height:44px;
      border:1px solid var(--border);
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:26px;
      color:var(--accent);
      cursor:pointer;
      user-select:none;
      background:#fff;
    }
    .plusBtn:hover{background:#faf7ff}
    .minusBtn{
      width:44px;height:44px;
      border:1px solid var(--border);
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:26px;
      color:#111;
      cursor:pointer;
      user-select:none;
      background:#fff;
    }
    .minusBtn:hover{background:#fafafa}
    .titleLine{
      font-size:26px;
      font-weight:900;
      margin:0;
      line-height:1.1;
    }
    .subLine{
      margin-top:8px;
      font-size:18px;
      font-weight:700;
    }
    .meta{
      margin-top:10px;
      font-size:18px;
    }
    .meta b{font-weight:900}
    .mutedLine{
      margin-top:6px;
      color:var(--muted);
      font-weight:600;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border:1px solid var(--border);
      border-radius:999px;
      font-weight:800;
      background:#fff;
    }

    .cartList{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .cartRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border:1px solid #efefef;
      border-radius:16px;
    }
    .cartName{font-weight:800; font-size:16px}
    .cartPct{font-weight:900}
    .ghost{
      color:var(--muted);
      font-weight:700;
    }

    .bigResult{
      font-size:44px;
      font-weight:1000;
      text-align:left;
      letter-spacing:.2px;
    }
    .resultBox{
      border:1px dashed #d7d7d7;
      border-radius:18px;
      padding:12px 14px;
      margin-top:10px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>חיפוש + שקלול אחוזי נכות</h1>
        <div id="ver">גרסה: טוען…</div>
      </div>
      <div class="pill">
        <span>נטענו</span>
        <span id="count">0</span>
        <span>רשומות ✅</span>
      </div>
    </header>

    <div class="grid">

      <!-- צד שמאל: מחשבון / סל -->
      <section class="card">
        <h2 class="cardTitle">מחשבון שקלול</h2>

        <div class="small">נבחרו <span id="cartCount">0</span></div>

        <div class="resultBox">
          <div class="small">תוצאה משוקללת</div>
          <div class="bigResult" id="totalPct">—</div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="clearCartBtn">איפוס רשימה</button>
          <button class="btn btnPrimary" id="copyBtn">העתק תוצאה</button>
        </div>

        <div class="small" style="margin-top:14px">או חישוב ידני (לדוגמה: <b>0.1 0.3</b> או <b>20 10 30</b>)</div>
        <div class="row" style="margin-top:10px">
          <input id="manualInput" type="text" placeholder="לדוגמה: 0.1 0.3 או 20 10 30" style="flex:1; min-width:260px">
          <button class="btn" id="manualCalcBtn">חשב</button>
        </div>
        <div class="small" id="manualOut" style="margin-top:10px"></div>

        <div class="cartList" id="cartList"></div>
      </section>

      <!-- צד ימין: חיפוש -->
      <section class="card">
        <div class="row">
          <input id="searchInput" type="text" placeholder="הקלידי מחלה / ממצא…" style="flex:1; min-width:260px">
          <button class="btn" id="searchBtn">ניקוי</button>
        </div>

        <div class="row" style="margin-top:10px">
          <select id="systemSelect" style="flex:1; min-width:260px">
            <option value="">כל המערכות</option>
          </select>
        </div>

        <div class="small" style="margin-top:12px">תוצאות</div>
        <div class="list" id="results"></div>
      </section>

    </div>
  </div>

<script>
  // =========================
  // 1) Helpers (בטוחים)
  // =========================
  const safe = v => (v === null || v === undefined) ? "" : String(v);
  const norm = s => safe(s).trim().toLowerCase();

  // ממיר 0.3 ל-30, משאיר 20 כ-20
  function toPercentNumber(v){
    const n = Number(v);
    if(!Number.isFinite(n)) return null;
    if(n > 0 && n < 1) return n * 100;
    return n;
  }

  // נוסחת שקלול: A + (100-A)*B/100 ...
  function calcCombined(percs){
    const nums = percs
      .map(toPercentNumber)
      .filter(x => x !== null && x >= 0)
      .sort((a,b)=>b-a);

    if(!nums.length) return 0;

    let comb = nums[0];
    for(let i=1;i<nums.length;i++){
      comb = comb + (100 - comb) * (nums[i] / 100);
    }
    return comb;
  }

  // =========================
  // 2) Data loading + normalize
  // =========================
  let DATA = [];
  let SYSTEMS = [];
  let CART = []; // items: {id, title, percent}

  function normalizeRow(row, idx){
    // ננסה לתמוך גם במפתחות באנגלית וגם בעברית
    const disease =
      safe(row.disease || row.name || row.title || row["מחלה"] || row["ממצא"] || row["אבחנה"] || "");
    const subtitle =
      safe(row.subtitle || row.details || row.desc || row["פירוט"] || row["תיאור"] || "");
    const system =
      safe(row.system || row.category || row["מערכת"] || row["קטגוריה"] || "");
    const percentRaw =
      row.percent ?? row.pct ?? row["אחוז"] ?? row["אחוז נכות"] ?? row["percent"] ?? row["pct"];

    const percent = toPercentNumber(percentRaw);

    const id = safe(row.id || row.code || row["קוד"] || "") || ("row-" + idx);

    return {
      id,
      disease: disease || "ללא שם",
      subtitle,
      system,
      percent: (percent === null ? null : percent)
    };
  }

  async function loadData(){
    // cache-bust קטן כדי שלא תתקעי על גרסה ישנה
    const url = "disability_table.json?v=" + Date.now();
    const res = await fetch(url);
    const json = await res.json();

    const arr = Array.isArray(json) ? json : (Array.isArray(json.data) ? json.data : []);
    DATA = arr.map(normalizeRow);

    SYSTEMS = [...new Set(DATA.map(x=>safe(x.system)).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'he'));
    renderSystems();
    updateCounts();
    renderResults();
  }

  function renderSystems(){
    const sel = document.getElementById("systemSelect");
    const current = sel.value;
    sel.innerHTML = `<option value="">כל המערכות</option>` + SYSTEMS.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("");
    sel.value = current || "";
  }

  function updateCounts(){
    document.getElementById("count").textContent = String(DATA.length);
    document.getElementById("cartCount").textContent = String(CART.length);
  }

  // =========================
  // 3) Search + Render
  // =========================
  function escapeHtml(str){
    return safe(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function matches(row, term, sys){
    if(sys && norm(row.system) !== norm(sys)) return false;
    if(!term) return true;
    const t = norm(term);
    return norm(row.disease).includes(t) || norm(row.subtitle).includes(t) || norm(row.system).includes(t);
  }

  function renderResults(){
    const term = document.getElementById("searchInput").value;
    const sys  = document.getElementById("systemSelect").value;

    const list = DATA.filter(r => matches(r, term, sys)).slice(0, 200); // כדי לא להכביד
    const box = document.getElementById("results");

    if(!list.length){
      box.innerHTML = `<div class="ghost">לא נמצאו תוצאות</div>`;
      return;
    }

    box.innerHTML = list.map(r => {
      const pct = (r.percent === null) ? "" : (Math.round(r.percent) + "%");
      const titleLine = `${escapeHtml(r.disease)}`;
      const sub = r.subtitle ? `<div class="subLine">${escapeHtml(r.subtitle)}</div>` : "";
      const meta = `
        <div class="meta"><b>מערכת:</b> ${escapeHtml(r.system || "—")}</div>
        <div class="meta"><b>תנאי:</b> ${escapeHtml((r.percent === null) ? "—" : String(r.percent/100).replace(/\.0$/,""))}</div>
      `;

      // "תנאי" מוצג כמו שהיה אצלך (0.3 וכו') כדי שתראי מקור,
      // אבל האחוז ליד הכפתור והסל — באחוזים אמיתיים.
      const conditionShown = (r.percent === null) ? "—" : ( (r.percent/100).toString() );

      return `
        <div class="item">
          <div class="pctBox">
            <div class="plusBtn" title="הוסף" data-add="${escapeHtml(r.id)}">+</div>
            <div>${pct || "—"}</div>
          </div>
          <div>
            <div class="titleLine">${titleLine}</div>
            ${sub}
            <div class="meta"><b>מערכת:</b> ${escapeHtml(r.system || "—")}</div>
            <div class="meta"><b>תנאי:</b> ${escapeHtml(conditionShown)}</div>
          </div>
        </div>
      `;
    }).join("");

    // bind add buttons
    box.querySelectorAll("[data-add]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-add");
        const row = DATA.find(x=>x.id===id);
        if(!row) return;
        if(row.percent === null) return alert("אין אחוז לרשומה הזו");
        addToCart(row);
      });
    });
  }

  function addToCart(row){
    // לא מוסיפים אותו ID פעמיים
    if(CART.some(x=>x.id===row.id)) return;

    CART.push({
      id: row.id,
      title: row.disease,
      percent: row.percent
    });

    recalcCart();
  }

  function removeFromCart(id){
    CART = CART.filter(x=>x.id!==id);
    recalcCart();
  }

  function recalcCart(){
    updateCounts();

    const total = calcCombined(CART.map(x=>x.percent));
    document.getElementById("totalPct").textContent = CART.length ? (total.toFixed(1) + "%") : "—";

    const cartList = document.getElementById("cartList");
    if(!CART.length){
      cartList.innerHTML = `<div class="ghost" style="margin-top:8px">אין רשומות בסל</div>`;
      return;
    }

    cartList.innerHTML = CART.map(x => `
      <div class="cartRow">
        <div>
          <div class="cartName">${escapeHtml(x.title)}</div>
          <div class="small">${Math.round(x.percent)}%</div>
        </div>
        <div class="minusBtn" title="הסר" data-remove="${escapeHtml(x.id)}">—</div>
      </div>
    `).join("");

    cartList.querySelectorAll("[data-remove]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        removeFromCart(btn.getAttribute("data-remove"));
      });
    });
  }

  // =========================
  // 4) Events
  // =========================
  document.getElementById("searchInput").addEventListener("input", renderResults);
  document.getElementById("systemSelect").addEventListener("change", renderResults);

  document.getElementById("searchBtn").addEventListener("click", ()=>{
    document.getElementById("searchInput").value = "";
    document.getElementById("systemSelect").value = "";
    renderResults();
  });

  document.getElementById("clearCartBtn").addEventListener("click", ()=>{
    CART = [];
    recalcCart();
  });

  document.getElementById("copyBtn").addEventListener("click", async ()=>{
    const total = calcCombined(CART.map(x=>x.percent));
    const text = CART.length ? ("סה\"כ נכות משוקלל: " + Math.round(total) + "%") : "אין רשומות";
    try{
      await navigator.clipboard.writeText(text);
      alert("הועתק ✅");
    }catch(e){
      alert(text);
    }
  });

  document.getElementById("manualCalcBtn").addEventListener("click", ()=>{
    const raw = document.getElementById("manualInput").value || "";
    const parts = raw.split(/[\s,]+/).filter(Boolean);
    const total = calcCombined(parts);
    document.getElementById("manualOut").textContent = parts.length ? ("סה\"כ: " + total.toFixed(1) + "%") : "";
  });

  // =========================
  // 5) Boot
  // =========================
  (function(){
    const d = new Date();
    document.getElementById("ver").textContent = "גרסה: " + d.toLocaleString("he-IL");
    recalcCart();
    loadData().catch(err=>{
      console.error(err);
      document.getElementById("results").innerHTML =
        `<div class="ghost">שגיאה בטעינת הנתונים. בדקי שהקובץ disability_table.json קיים בריפו.</div>`;
    });
  })();
</script>

</body>
</html>
