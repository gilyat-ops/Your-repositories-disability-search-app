async function loadData() {
  try {
    const res = await fetch("disability_table.json");
    window.disabilityData = await res.json();
  } catch {
    window.disabilityData = [];
  }
}

function searchDisease(term) {
  if (!window.disabilityData) return [];
  const t = term.trim().toLowerCase();
  return window.disabilityData.filter(x =>
    x.disease.toLowerCase().includes(t) ||
    (x.subtitle && x.subtitle.toLowerCase().includes(t))
  );
}

function toPercentNumber(v) {
  const n = Number(v);
  if (!Number.isFinite(n)) return null;
  if (n > 0 && n < 1) return n * 100;
  return n;
}

function calculateCombined(ps) {
  if (!Array.isArray(ps)) return 0;
  const nums = ps.map(toPercentNumber).filter(x => x !== null && x >= 0);
  if (!nums.length) return 0;
  nums.sort((a, b) => b - a);
  let comb = nums[0];
  for (let i = 1; i < nums.length; i++) {
    comb = comb + (100 - comb) * (nums[i] / 100);
  }
  return comb;
}

function renderResults(list) {
  const box = document.getElementById("results");
  if (!box) return;
  if (!list.length) {
    box.innerHTML = "<p>לא נמצאו תוצאות</p>";
    return;
  }
  box.innerHTML = list.map(x => {
    const percent = toPercentNumber(x.percent);
    return `<div class="card">
      <h3>${x.disease}</h3>
      ${x.subtitle ? `<p>${x.subtitle}</p>` : ""}
      ${percent !== null ? `<strong>${percent}% נכות</strong>` : ""}
    </div>`;
  }).join("");
}

document.getElementById("searchBtn").onclick = async () => {
  const term = document.getElementById("searchInput").value;
  const found = searchDisease(term);
  renderResults(found);
};

document.getElementById("calcBtn").onclick = () => {
  const vals = document.getElementById("calcInput").value.split(/[, ]+/);
  const total = calculateCombined(vals.map(Number));
  document.getElementById("totalBox").textContent = total.toFixed(1) + "%";
};

loadData();
