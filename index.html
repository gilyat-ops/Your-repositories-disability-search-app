<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>×—×™×¤×•×© ××—×•×–×™ × ×›×•×ª</title>
</head>
<body style="font-family: Arial; padding: 16px; max-width: 900px; margin: 0 auto;">
  <h2 style="margin:0 0 10px 0;">×—×™×¤×•×© ××—×•×–×™ × ×›×•×ª</h2>

  <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
    <input id="search"
           placeholder="×”×§×œ×“ ××—×œ×” / ×ª×ª-××—×œ×” / ×ª× ××™â€¦"
           style="flex: 1 1 280px; padding:12px; font-size:18px; box-sizing:border-box; border:1px solid #ccc; border-radius:12px;"/>

    <select id="systemFilter"
            style="flex: 0 0 220px; padding:12px; font-size:16px; border:1px solid #ccc; border-radius:12px;">
      <option value="">×›×œ ×”××¢×¨×›×•×ª</option>
    </select>

    <button id="clearBtn"
            style="padding:12px 14px; font-size:16px; border:1px solid #ccc; border-radius:12px; background:#fff; cursor:pointer;">
      × ×™×§×•×™
    </button>
  </div>

  <div id="status" style="margin:12px 2px; opacity:0.85;"></div>
  <div id="results"></div>

<script>
  const statusEl = document.getElementById('status');
  const resultsEl = document.getElementById('results');
  const searchEl  = document.getElementById('search');
  const systemEl  = document.getElementById('systemFilter');
  const clearBtn  = document.getElementById('clearBtn');

  const safe = v => (v === null || v === undefined) ? "" : String(v);
  const norm = s => safe(s).trim().toLowerCase();

  let DATA = [];
  let SYSTEMS = [];

  function escapeHtml(str){
    return safe(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function highlight(text, q){
    const t = safe(text);
    const query = safe(q).trim();
    if(!query) return escapeHtml(t);
    // ×”×“×’×©×” ×¤×©×•×˜×” (×œ× ×¨×’×³×§×¡ ××¡×•×›×Ÿ)
    const lowerT = t.toLowerCase();
    const lowerQ = query.toLowerCase();
    const idx = lowerT.indexOf(lowerQ);
    if(idx === -1) return escapeHtml(t);
    const before = escapeHtml(t.slice(0, idx));
    const mid    = escapeHtml(t.slice(idx, idx + query.length));
    const after  = escapeHtml(t.slice(idx + query.length));
    return `${before}<mark style="background:#ffe58a; padding:0 2px; border-radius:4px;">${mid}</mark>${after}`;
  }

  function buildSystemOptions(){
    // × ×§×” ×•×©×—×–×¨
    const current = systemEl.value;
    systemEl.innerHTML = `<option value="">×›×œ ×”××¢×¨×›×•×ª</option>` + SYSTEMS
      .map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`)
      .join("");
    // × ×¡×” ×œ×©××•×¨ ×‘×—×™×¨×”
    if(SYSTEMS.includes(current)) systemEl.value = current;
  }

  function toCard(x, q){
    const disease = safe(x.disease);
    const sub     = safe(x.sub_disease);
    const cond    = safe(x.condition);
    const sys     = safe(x.system);
    const pctVal  = safe(x.percent);
    const pct     = pctVal ? (pctVal + "%") : "â€”";

    const titleParts = [disease, (sub && sub !== "â€”") ? sub : ""].filter(Boolean);
    const title = titleParts.join(" â€¢ ");

    // ×˜×§×¡×˜ ×œ×”×¢×ª×§×”
    const copyText = `${title || disease || "â€”"} â€“ ${pct}`;

    return `
      <div style="border:1px solid #e2e2e2; border-radius:14px; padding:12px; margin:10px 0; background:#fff;">
        <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start;">
          <div style="font-weight:800; font-size:16px; line-height:1.25;">
            ${highlight(title || "â€”", q)}
          </div>
          <div style="font-weight:900; font-size:18px; white-space:nowrap;">${escapeHtml(pct)}</div>
        </div>

        <div style="margin-top:8px; opacity:0.85; font-size:14px;">
          <div><b>××¢×¨×›×ª:</b> ${highlight(sys || "â€”", q)}</div>
          <div style="margin-top:4px;"><b>×ª× ××™:</b> ${highlight(cond || "â€”", q)}</div>
        </div>

        <div style="margin-top:10px; display:flex; justify-content:flex-end;">
          <button class="copyBtn"
                  data-copy="${escapeHtml(copyText)}"
                  style="padding:10px 12px; border:1px solid #ccc; border-radius:12px; background:#fff; cursor:pointer;">
            ğŸ“‹ ×”×¢×ª×§
          </button>
        </div>
      </div>
    `;
  }

  function render(){
    const q = norm(searchEl.value);
    const sysFilter = norm(systemEl.value);

    // ×›×©×”×—×™×¤×•×© ×¨×™×§ â€” ×œ× ×œ×”×¦×™×£
    if(!q && !sysFilter){
      statusEl.textContent = `× ×˜×¢× ×• ${DATA.length} ×¨×©×•××•×ª âœ… Â· ×”×§×œ×™×“×™ ×›×“×™ ×œ×—×¤×© ××• ×‘×—×¨×™ ××¢×¨×›×ª.`;
      resultsEl.innerHTML = `<div style="opacity:0.7; margin-top:10px;">×˜×™×¤: ×›×ª×‘×™ "×‘×¨×š" / "×˜×¨×©×ª" / "×¡×¨×˜×Ÿ"â€¦</div>`;
      return;
    }

    // ×¡×™× ×•×Ÿ
    let out = DATA.filter(x => {
      const sys = norm(x.system);
      if(sysFilter && sys !== sysFilter) return false;

      if(!q) return true; // ×¨×§ ×œ×¤×™ ××¢×¨×›×ª

      const blob = (
        safe(x.disease) + " " +
        safe(x.sub_disease) + " " +
        safe(x.condition) + " " +
        safe(x.system)
      ).toLowerCase();
      return blob.includes(q);
    });

    const total = out.length;
    out = out.slice(0, 200);

    statusEl.textContent = `× ××¦××• ${total} ×ª×•×¦××•×ª Â· ××¦×™×’ ×¢×“ 200`;

    resultsEl.innerHTML = out.length
      ? out.map(x => toCard(x, q)).join("")
      : `<div style="opacity:0.7; margin-top:10px;">×œ× × ××¦××• ×ª×•×¦××•×ª.</div>`;

    // ×—×™×‘×•×¨ ×›×¤×ª×•×¨×™ ×”×¢×ª×§×”
    document.querySelectorAll('.copyBtn').forEach(btn => {
      btn.onclick = async () => {
        const text = btn.getAttribute('data-copy') || "";
        try{
          await navigator.clipboard.writeText(text);
          const old = btn.textContent;
          btn.textContent = "âœ… ×”×•×¢×ª×§";
          setTimeout(()=> btn.textContent = old, 900);
        } catch(e){
          // fallback
          const ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          const old = btn.textContent;
          btn.textContent = "âœ… ×”×•×¢×ª×§";
          setTimeout(()=> btn.textContent = old, 900);
        }
      };
    });
  }

  // Debounce ×§×˜×Ÿ ×©×œ× ×™×—× ×•×§
  let t = null;
  function scheduleRender(){
    clearTimeout(t);
    t = setTimeout(render, 80);
  }

  clearBtn.onclick = () => {
    searchEl.value = "";
    systemEl.value = "";
    render();
    searchEl.focus();
  };

  statusEl.textContent = "×˜×•×¢×Ÿ × ×ª×•× ×™×â€¦";

  fetch('./disability_table.json', { cache: "no-store" })
    .then(r => {
      if(!r.ok) throw new Error("×œ× × ×˜×¢×Ÿ disability_table.json (×¡×˜×˜×•×¡ " + r.status + ")");
      return r.json();
    })
    .then(data => {
      // × ×™×§×•×™ ×‘×¡×™×¡×™: ×œ× ×œ×”×ª×¨×¡×§ ×¢×œ ×©×•×¨×•×ª ×‘×¢×™×™×ª×™×•×ª
      DATA = Array.isArray(data) ? data : [];

      // ×‘× ×” ×¨×©×™××ª ××¢×¨×›×•×ª
      const set = new Set();
      for(const x of DATA){
        const s = safe(x.system).trim();
        if(s) set.add(s);
      }
      SYSTEMS = Array.from(set).sort((a,b)=>a.localeCompare(b, 'he'));

      buildSystemOptions();

      statusEl.textContent = `× ×˜×¢× ×• ${DATA.length} ×¨×©×•××•×ª âœ…`;
      render();

      searchEl.addEventListener('input', scheduleRender);
      systemEl.addEventListener('change', render);
    })
    .catch(err => {
      statusEl.textContent = "×©×’×™××”: " + err.message;
      resultsEl.innerHTML = `<div style="opacity:0.7">×•×“××™ ×©×”×§×•×‘×¥ disability_table.json × ××¦× ×‘××•×ª×• ××§×•× ×›××• index.html.</div>`;
      console.error(err);
    });
</script>
</body>
</html>
